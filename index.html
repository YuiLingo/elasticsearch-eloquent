<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Elasticsearch Eloquent by isswp101</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Elasticsearch Eloquent</h1>
      <h2 class="project-tagline">Elasticsearch functionality like Laravel Eloquent models</h2>
      <a href="https://github.com/isswp101/elasticsearch-eloquent" class="btn">View on GitHub</a>
      <a href="https://github.com/isswp101/elasticsearch-eloquent/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/isswp101/elasticsearch-eloquent/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="persimmon--elasticsearch-eloquent" class="anchor" href="#persimmon--elasticsearch-eloquent" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Persimmon / Elasticsearch Eloquent</h1>

<p><a href="https://packagist.org/packages/isswp101/elasticsearch-eloquent"><img src="https://img.shields.io/packagist/v/isswp101/elasticsearch-eloquent.svg?style=flat-square" alt="Latest Version on Packagist"></a>
<a href="LICENSE.md"><img src="https://img.shields.io/badge/license-MIT-brightgreen.svg?style=flat-square" alt="Software License"></a>
<a href="https://travis-ci.org/isswp101/elasticsearch-eloquent"><img src="https://img.shields.io/travis/isswp101/elasticsearch-eloquent/master.svg?style=flat-square" alt="Build Status"></a>
<a href="https://scrutinizer-ci.com/g/isswp101/elasticsearch-eloquent/code-structure"><img src="https://img.shields.io/scrutinizer/coverage/g/isswp101/elasticsearch-eloquent.svg?style=flat-square" alt="Coverage Status"></a>
<a href="https://scrutinizer-ci.com/g/isswp101/elasticsearch-eloquent"><img src="https://img.shields.io/scrutinizer/g/isswp101/elasticsearch-eloquent.svg?style=flat-square" alt="Quality Score"></a>
<a href="https://packagist.org/packages/isswp101/elasticsearch-eloquent"><img src="https://img.shields.io/packagist/dt/isswp101/elasticsearch-eloquent.svg?style=flat-square" alt="Total Downloads"></a></p>

<p>This package allows you to interact with Elasticsearch as you interact with Eloquent models in Laravel.<br>
Feel free to improve the project.</p>

<h2>
<a id="install" class="anchor" href="#install" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Install</h2>

<p>Via Composer</p>

<div class="highlight highlight-source-shell"><pre>$ composer require isswp101/elasticsearch-eloquent</pre></div>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage</h2>

<h3>
<a id="configure-dependencies" class="anchor" href="#configure-dependencies" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configure dependencies</h3>

<blockquote>
<p><strong>Warning!</strong> First of all you should create a base model and inherit from it their models.</p>
</blockquote>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">Elasticsearch\Client</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">Isswp101\Persimmon\DAL\DALMediator</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">Isswp101\Persimmon\DAL\ElasticsearchDAL</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">Isswp101\Persimmon\ElasticsearchModel</span> <span class="pl-k">as</span> <span class="pl-c1">Model</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">ElasticsearchModel</span> <span class="pl-k">extends</span> <span class="pl-e">Model</span></span>
<span class="pl-s1">{</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-c1">__construct</span>(<span class="pl-k">array</span> <span class="pl-smi">$attributes</span> <span class="pl-k">=</span> [])</span>
<span class="pl-s1">    {</span>
<span class="pl-s1">        <span class="pl-smi">$dal</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">ElasticsearchDAL</span>(<span class="pl-smi">$this</span>, app(<span class="pl-c1">Client</span><span class="pl-k">::</span><span class="pl-c1">class</span>), <span class="pl-k">new</span> <span class="pl-c1">DALMediator</span>());</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-k">parent</span><span class="pl-k">::</span>__construct(<span class="pl-smi">$dal</span>, <span class="pl-smi">$attributes</span>);</span>
<span class="pl-s1">    }</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">function</span> <span class="pl-en">createInstance</span>()</span>
<span class="pl-s1">    {</span>
<span class="pl-s1">        <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-k">static</span>();</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>In this example we use Laravel IoC Container to resolve <code>Elasticsearch\Client</code> dependency as <code>app(Client::class)</code>.</p>

<h3>
<a id="create-a-new-model" class="anchor" href="#create-a-new-model" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Create a new model</h3>

<p>You must override static variables <code>index</code> and <code>type</code> to determine the document path.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">Product</span> <span class="pl-k">extends</span> <span class="pl-e">ElasticsearchModel</span></span>
<span class="pl-s1">{</span>
<span class="pl-s1">    <span class="pl-k">protected</span> <span class="pl-k">static</span> <span class="pl-smi">$index</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>test<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">    <span class="pl-k">protected</span> <span class="pl-k">static</span> <span class="pl-smi">$type</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>test<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-smi">$name</span>;</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-smi">$price</span> <span class="pl-k">=</span> <span class="pl-c1">0</span>;</span>
<span class="pl-s1">}</span></pre></div>

<p>Here <code>name</code> and <code>price</code> are fields which will be stored in Elasticsearch.  </p>

<blockquote>
<p><strong>Warning!</strong> Don't use field names starting with underscore <code>$_*</code>, for example <code>$_name</code>.</p>
</blockquote>

<p>Use the static <code>create()</code> method to create document in Elasticsearch:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>create([<span class="pl-s"><span class="pl-pds">'</span>id<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">3</span>, <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>Product 3<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>price<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">30</span>]);</span></pre></div>

<h3>
<a id="save-the-model" class="anchor" href="#save-the-model" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Save the model</h3>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Product</span>();</span>
<span class="pl-s1"><span class="pl-smi">$product</span><span class="pl-k">-&gt;</span><span class="pl-smi">id</span> <span class="pl-k">=</span> <span class="pl-c1">1</span>;</span>
<span class="pl-s1"><span class="pl-smi">$product</span><span class="pl-k">-&gt;</span><span class="pl-smi">name</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>Product 1<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1"><span class="pl-smi">$product</span><span class="pl-k">-&gt;</span><span class="pl-smi">price</span> <span class="pl-k">=</span> <span class="pl-c1">20</span>;</span>
<span class="pl-s1"><span class="pl-smi">$product</span><span class="pl-k">-&gt;</span>save();</span></pre></div>

<p>Use <code>save()</code> method to store model data in Elasticsearch. Let's see how this looks in Elasticsearch:</p>

<div class="highlight highlight-source-json"><pre>{
   <span class="pl-s"><span class="pl-pds">"</span>_index<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>test<span class="pl-pds">"</span></span>,
   <span class="pl-s"><span class="pl-pds">"</span>_type<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>test<span class="pl-pds">"</span></span>,
   <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>1<span class="pl-pds">"</span></span>,
   <span class="pl-s"><span class="pl-pds">"</span>_version<span class="pl-pds">"</span></span>: <span class="pl-c1">1</span>,
   <span class="pl-s"><span class="pl-pds">"</span>found<span class="pl-pds">"</span></span>: <span class="pl-c1">true</span>,
   <span class="pl-s"><span class="pl-pds">"</span>_source<span class="pl-pds">"</span></span>: {
      <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Product 1<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>price<span class="pl-pds">"</span></span>: <span class="pl-c1">10</span>,
      <span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>: <span class="pl-c1">1</span>,
      <span class="pl-s"><span class="pl-pds">"</span>user_id<span class="pl-pds">"</span></span>: <span class="pl-c1">null</span>,
      <span class="pl-s"><span class="pl-pds">"</span>created_at<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>2016-06-03 08:11:08<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>updated_at<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>2016-06-03 08:11:08<span class="pl-pds">"</span></span>
   }
}</pre></div>

<p>Fields <code>created_at</code> and <code>updated_at</code> were created automatically. The <code>user_id</code> field is persistent field to store user id.</p>

<h3>
<a id="find-existing-model" class="anchor" href="#find-existing-model" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Find existing model</h3>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>find(<span class="pl-c1">1</span>);</span></pre></div>

<p>If you have big data in Elasticsearch you can specify certain fields to retrieve:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>find(<span class="pl-c1">1</span>, [<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>]);</span></pre></div>

<p>In this case the <code>price</code> field equals <code>0</code> because it's populated as the default value that you specified in the model.</p>

<p>There are the following methods:</p>

<ul>
<li>
<code>findOrFail()</code> returns <code>ModelNotFoundException</code> exception if no result found.</li>
<li>
<code>findOrNew()</code> returns a new model if no result found.</li>
</ul>

<h3>
<a id="model-cache" class="anchor" href="#model-cache" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Model cache</h3>

<p>There is a smart model cache when you use methods like <code>find()</code>, <code>findOrFail()</code> and so on.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>find(<span class="pl-c1">1</span>, [<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>]);  <span class="pl-c">// will be retrieved from the elasticsearch</span></span>
<span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>find(<span class="pl-c1">1</span>, [<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>]);  <span class="pl-c">// will be retrieved from the cache</span></span>
<span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>find(<span class="pl-c1">1</span>, [<span class="pl-s"><span class="pl-pds">'</span>price<span class="pl-pds">'</span></span>]); <span class="pl-c">// elasticsearch</span></span>
<span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>find(<span class="pl-c1">1</span>, [<span class="pl-s"><span class="pl-pds">'</span>price<span class="pl-pds">'</span></span>]); <span class="pl-c">// cache</span></span>
<span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>find(<span class="pl-c1">1</span>, [<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>]);  <span class="pl-c">// cache</span></span></pre></div>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>findOrFail(<span class="pl-c1">1</span>);      <span class="pl-c">// elasticsearch</span></span>
<span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>find(<span class="pl-c1">1</span>);            <span class="pl-c">// cache</span></span>
<span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>find(<span class="pl-c1">1</span>, [<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>]);  <span class="pl-c">// cache</span></span>
<span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>find(<span class="pl-c1">1</span>, [<span class="pl-s"><span class="pl-pds">'</span>price<span class="pl-pds">'</span></span>]); <span class="pl-c">// cache</span></span></pre></div>

<h3>
<a id="partial-update" class="anchor" href="#partial-update" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Partial update</h3>

<p>You can use partial update to update specific fields quickly.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>find(<span class="pl-c1">1</span>, [<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>]);</span>
<span class="pl-s1"><span class="pl-smi">$product</span><span class="pl-k">-&gt;</span><span class="pl-smi">name</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>Product 3<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1"><span class="pl-smi">$product</span><span class="pl-k">-&gt;</span>save(<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>);</span></pre></div>

<h3>
<a id="delete-models" class="anchor" href="#delete-models" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Delete models</h3>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>find(<span class="pl-c1">1</span>);</span>
<span class="pl-s1"><span class="pl-smi">$product</span><span class="pl-k">-&gt;</span>delete();</span></pre></div>

<p>You can use the static method:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c1">Product</span><span class="pl-k">::</span>destroy(<span class="pl-c1">1</span>);</span></pre></div>

<h3>
<a id="model-events" class="anchor" href="#model-events" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Model events</h3>

<p>Out of the box you are provided with a simple implementation of events.<br>
You can override the following methods to define events:</p>

<ul>
<li>
<code>saving()</code> is called before saving, updating, creating the model</li>
<li>
<code>saved()</code> is called after saving, updating, creating the model</li>
<li>
<code>deleting()</code> is called before deleting the model</li>
<li>
<code>deleted()</code> is called after deleting the model</li>
</ul>

<p>For example:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">Product</span> <span class="pl-k">extends</span> <span class="pl-e">ElasticsearchModel</span></span>
<span class="pl-s1">{</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-smi">$index</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>test<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-smi">$type</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>test<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-smi">$name</span>;</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-smi">$price</span> <span class="pl-k">=</span> <span class="pl-c1">0</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">protected</span> <span class="pl-k">function</span> <span class="pl-en">saving</span>()</span>
<span class="pl-s1">    {</span>
<span class="pl-s1">        <span class="pl-k">if</span> (<span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">price</span> <span class="pl-k">&lt;=</span> <span class="pl-c1">0</span>) {</span>
<span class="pl-s1">            <span class="pl-k">return</span> <span class="pl-c1">false</span>;</span>
<span class="pl-s1">        }</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-k">return</span> <span class="pl-c1">true</span>;</span>
<span class="pl-s1">    }</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">protected</span> <span class="pl-k">function</span> <span class="pl-en">deleting</span>()</span>
<span class="pl-s1">    {</span>
<span class="pl-s1">        <span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>canDelete()) {</span>
<span class="pl-s1">            <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-c1">LogicException</span>(<span class="pl-s"><span class="pl-pds">'</span>No permissions to delete the model<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1">        }</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-k">return</span> <span class="pl-c1">true</span>;</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<h3>
<a id="basic-search" class="anchor" href="#basic-search" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Basic search</h3>

<p>There are helpers to search documents:</p>

<p>The <code>first($query)</code> method returns the first document according to the query or <code>null</code>.  </p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>first(<span class="pl-smi">$query</span>);</span></pre></div>

<p>The <code>firstOrFail($query)</code> method returns <code>ModelNotFoundException</code> exception if <code>first($query)</code> returns <code>null</code>.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$product</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>firstOrFail(<span class="pl-smi">$query</span>);</span></pre></div>

<p>The <code>search($query)</code> method returns documents (default 50 items) according to the query.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$products</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>search(<span class="pl-smi">$query</span>);</span></pre></div>

<p>The <code>map($query, callable $callback)</code> method returns all documents (default 50 items per request) according to the query.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$total</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>map([], <span class="pl-k">function</span> (<span class="pl-c1">Product</span> <span class="pl-smi">$product</span>) {</span>
<span class="pl-s1">    <span class="pl-c">// ...</span></span>
<span class="pl-s1">});</span></pre></div>

<p>The <code>all($query)</code> method returns all documents according to the query.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$products</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>all(<span class="pl-smi">$query</span>);</span></pre></div>

<p>If <code>$query</code> is not passed the query will be as <code>match_all</code> query.</p>

<h3>
<a id="query-builder" class="anchor" href="#query-builder" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Query Builder</h3>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">Isswp101\Persimmon\QueryBuilder\QueryBuilder</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-smi">$query</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">QueryBuilder</span>();</span></pre></div>

<p>Simple usage:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$query</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">QueryBuilder</span>([<span class="pl-s"><span class="pl-pds">'</span>query<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> [<span class="pl-s"><span class="pl-pds">'</span>match<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> [<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>Product<span class="pl-pds">'</span></span>]]]);</span>
<span class="pl-s1"><span class="pl-smi">$products</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>search(<span class="pl-smi">$query</span>);</span></pre></div>

<p>The <code>match</code> query:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$query</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">QueryBuilder</span>();</span>
<span class="pl-s1"><span class="pl-smi">$query</span><span class="pl-k">-&gt;</span>match(<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>Product<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-smi">$products</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>search(<span class="pl-smi">$query</span>);    </span></pre></div>

<p>The <code>range</code> query:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$query</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">QueryBuilder</span>();</span>
<span class="pl-s1"><span class="pl-smi">$query</span><span class="pl-k">-&gt;</span>betweenOrEquals(<span class="pl-s"><span class="pl-pds">'</span>price<span class="pl-pds">'</span></span>, <span class="pl-c1">20</span>, <span class="pl-c1">30</span>)<span class="pl-k">-&gt;</span>greaterThan(<span class="pl-s"><span class="pl-pds">'</span>price<span class="pl-pds">'</span></span>, <span class="pl-c1">15</span>);</span>
<span class="pl-s1"><span class="pl-smi">$products</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>search(<span class="pl-smi">$query</span>);</span></pre></div>

<h3>
<a id="filters" class="anchor" href="#filters" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Filters</h3>

<p>Feel free to add your own filters.</p>

<p>The <code>TermFilter</code> filter:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$query</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">QueryBuilder</span>();</span>
<span class="pl-s1"><span class="pl-smi">$query</span><span class="pl-k">-&gt;</span>filter(<span class="pl-k">new</span> <span class="pl-c1">TermFilter</span>(<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>2<span class="pl-pds">'</span></span>));</span>
<span class="pl-s1"><span class="pl-smi">$products</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>search(<span class="pl-smi">$query</span>);</span></pre></div>

<p>The <code>IdsFilter</code> filter:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$query</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">QueryBuilder</span>();</span>
<span class="pl-s1"><span class="pl-smi">$query</span><span class="pl-k">-&gt;</span>filter(<span class="pl-k">new</span> <span class="pl-c1">IdsFilter</span>([<span class="pl-c1">1</span>, <span class="pl-c1">3</span>]));</span>
<span class="pl-s1"><span class="pl-smi">$products</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>search(<span class="pl-smi">$query</span>);</span></pre></div>

<p>The <code>RangeOrExistFilter</code> filter:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$query</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">QueryBuilder</span>();</span>
<span class="pl-s1"><span class="pl-smi">$query</span><span class="pl-k">-&gt;</span>filter(<span class="pl-k">new</span> <span class="pl-c1">RangeOrExistFilter</span>(<span class="pl-s"><span class="pl-pds">'</span>price<span class="pl-pds">'</span></span>, [<span class="pl-s"><span class="pl-pds">'</span>gte<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">20</span>]));</span>
<span class="pl-s1"><span class="pl-smi">$products</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>search(<span class="pl-smi">$query</span>);</span></pre></div>

<h3>
<a id="aggregations" class="anchor" href="#aggregations" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Aggregations</h3>

<p>Feel free to add your own aggregations.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$query</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">QueryBuilder</span>();</span>
<span class="pl-s1"><span class="pl-smi">$query</span><span class="pl-k">-&gt;</span>aggregation(<span class="pl-k">new</span> <span class="pl-c1">TermsAggregation</span>(<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>));</span>
<span class="pl-s1"><span class="pl-smi">$products</span> <span class="pl-k">=</span> <span class="pl-c1">Product</span><span class="pl-k">::</span>search(<span class="pl-smi">$query</span>);</span>
<span class="pl-s1"><span class="pl-smi">$buckets</span> <span class="pl-k">=</span> <span class="pl-smi">$products</span><span class="pl-k">-&gt;</span>getAggregation(<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-c">// Usage: $buckets[0]-&gt;getKey() and $buckets[0]-&gt;getCount()</span></span></pre></div>

<h3>
<a id="parent-child-relationship" class="anchor" href="#parent-child-relationship" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Parent-Child Relationship</h3>

<p>The parent-child relationship is similar in nature to the nested model: both allow you to associate one entity with another. The difference is that, with nested objects, all entities live within the same document while, with parent-child, the parent and children are completely separate documents.</p>

<p>Let's create two models:</p>

<ol>
<li>
<code>PurchaseOrder</code> has many <code>PurchaseOrderLine</code> models</li>
<li>
<code>PurchaseOrderLine</code> belongs to <code>PurchaseOrder</code> model</li>
</ol>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">PurchaseOrder</span> <span class="pl-k">extends</span> <span class="pl-e">ElasticsearchModel</span></span>
<span class="pl-s1">{</span>
<span class="pl-s1">    <span class="pl-k">protected</span> <span class="pl-k">static</span> <span class="pl-smi">$index</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>test_parent_child_rel<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">    <span class="pl-k">protected</span> <span class="pl-k">static</span> <span class="pl-smi">$type</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>orders<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-smi">$name</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">lines</span>()</span>
<span class="pl-s1">    {</span>
<span class="pl-s1">        <span class="pl-k">return</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>hasMany(<span class="pl-c1">PurchaseOrderLine</span><span class="pl-k">::</span><span class="pl-c1">class</span>);</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">PurchaseOrderLine</span> <span class="pl-k">extends</span> <span class="pl-e">ElasticsearchModel</span></span>
<span class="pl-s1">{</span>
<span class="pl-s1">    <span class="pl-k">protected</span> <span class="pl-k">static</span> <span class="pl-smi">$index</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>test_parent_child_rel<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">    <span class="pl-k">protected</span> <span class="pl-k">static</span> <span class="pl-smi">$type</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>lines<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">    <span class="pl-k">protected</span> <span class="pl-k">static</span> <span class="pl-smi">$parentType</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>orders<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-smi">$name</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">po</span>()</span>
<span class="pl-s1">    {</span>
<span class="pl-s1">        <span class="pl-k">return</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>belongsTo(<span class="pl-c1">PurchaseOrder</span><span class="pl-k">::</span><span class="pl-c1">class</span>);</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>To <code>save()</code> models you can use the following code:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$po</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">PurchaseOrder</span>([<span class="pl-s"><span class="pl-pds">'</span>id<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>PO1<span class="pl-pds">'</span></span>]);</span>
<span class="pl-s1"><span class="pl-smi">$line</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">PurchaseOrderLine</span>([<span class="pl-s"><span class="pl-pds">'</span>id<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>Line1<span class="pl-pds">'</span></span>]);</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-smi">$po</span><span class="pl-k">-&gt;</span>save();</span>
<span class="pl-s1"><span class="pl-smi">$po</span><span class="pl-k">-&gt;</span>lines()<span class="pl-k">-&gt;</span>save(<span class="pl-smi">$line</span>);</span></pre></div>

<p>You can use the <code>associate()</code> method to save models:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$po</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">PurchaseOrder</span>([<span class="pl-s"><span class="pl-pds">'</span>id<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>PO1<span class="pl-pds">'</span></span>]);</span>
<span class="pl-s1"><span class="pl-smi">$line</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">PurchaseOrderLine</span>([<span class="pl-s"><span class="pl-pds">'</span>id<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>Line1<span class="pl-pds">'</span></span>]);</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-smi">$po</span><span class="pl-k">-&gt;</span>save();</span>
<span class="pl-s1"><span class="pl-smi">$line</span><span class="pl-k">-&gt;</span>po()<span class="pl-k">-&gt;</span>associate(<span class="pl-smi">$po</span>);</span>
<span class="pl-s1"><span class="pl-smi">$line</span><span class="pl-k">-&gt;</span>save();</span></pre></div>

<p>To get parent you can use the following code:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$line</span> <span class="pl-k">=</span> <span class="pl-c1">PurchaseOrderLine</span><span class="pl-k">::</span>findWithParentId(<span class="pl-c1">1</span>, <span class="pl-c1">1</span>);</span>
<span class="pl-s1"><span class="pl-smi">$po</span> <span class="pl-k">=</span> <span class="pl-smi">$line</span><span class="pl-k">-&gt;</span>po()<span class="pl-k">-&gt;</span>get();</span></pre></div>

<p>To get children you can use the following code:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$po</span> <span class="pl-k">=</span> <span class="pl-c1">PurchaseOrder</span><span class="pl-k">::</span>findOrFail(<span class="pl-c1">1</span>);</span>
<span class="pl-s1"><span class="pl-smi">$line</span> <span class="pl-k">=</span> <span class="pl-smi">$po</span><span class="pl-k">-&gt;</span>lines()<span class="pl-k">-&gt;</span>find(<span class="pl-c1">1</span>); <span class="pl-c">// by id</span></span>
<span class="pl-s1"><span class="pl-smi">$lines</span> <span class="pl-k">=</span> <span class="pl-smi">$po</span><span class="pl-k">-&gt;</span>lines()<span class="pl-k">-&gt;</span>get(); <span class="pl-c">// all children</span></span></pre></div>

<h3>
<a id="inner-hits" class="anchor" href="#inner-hits" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Inner hits</h3>

<p>The parent/child and nested features allow the return of documents that have matches in a different scope. In the parent/child case, parent document are returned based on matches in child documents or child document are returned based on matches in parent documents. In the nested case, documents are returned based on matches in nested inner objects.</p>

<p>You can get parent model using only one request with <code>InnerHitsFilter</code> filter:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$query</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">QueryBuilder</span>();</span>
<span class="pl-s1"><span class="pl-smi">$query</span><span class="pl-k">-&gt;</span>filter(<span class="pl-k">new</span> <span class="pl-c1">InnerHitsFilter</span>(<span class="pl-c1">PurchaseOrderLine</span><span class="pl-k">::</span>getParentType()));</span>
<span class="pl-s1"><span class="pl-smi">$line</span> <span class="pl-k">=</span> <span class="pl-c1">PurchaseOrderLine</span><span class="pl-k">::</span>search(<span class="pl-smi">$query</span>)<span class="pl-k">-&gt;</span>first();</span>
<span class="pl-s1"><span class="pl-smi">$po</span> <span class="pl-k">=</span> <span class="pl-smi">$line</span><span class="pl-k">-&gt;</span>po()<span class="pl-k">-&gt;</span>get(); <span class="pl-c">// will be retrieved from inner_hits cache</span></span></pre></div>

<h3>
<a id="debugging-and-data-access-layer-events" class="anchor" href="#debugging-and-data-access-layer-events" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Debugging and data access layer events</h3>

<p>To debug all elasticsearch queries to search you can use own <code>DALEmitter</code> class:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">Isswp101\Persimmon\DAL\DALMediator</span>;</span>
<span class="pl-s1"><span class="pl-k">use</span> <span class="pl-c1">Log</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">DALEmitter</span> <span class="pl-k">extends</span> <span class="pl-e">DALMediator</span></span>
<span class="pl-s1">{</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-c1">__construct</span>()</span>
<span class="pl-s1">    {</span>
<span class="pl-s1">        <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>attach(<span class="pl-c1">DALMediator</span><span class="pl-k">::</span><span class="pl-c1">EVENT_BEFORE_SEARCH</span>, <span class="pl-k">function</span> (<span class="pl-k">array</span> <span class="pl-smi">$params</span>) {</span>
<span class="pl-s1">            <span class="pl-c1">Log</span><span class="pl-k">::</span>debug(<span class="pl-s"><span class="pl-pds">'</span>Elasticsearch query<span class="pl-pds">'</span></span>, <span class="pl-smi">$params</span>);</span>
<span class="pl-s1">        });</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>

<p>And configure it in your service provider:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">class</span> <span class="pl-en">ElasticsearchModel</span> <span class="pl-k">extends</span> <span class="pl-e">Model</span></span>
<span class="pl-s1">{</span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-c1">__construct</span>(<span class="pl-k">array</span> <span class="pl-smi">$attributes</span> <span class="pl-k">=</span> [])</span>
<span class="pl-s1">    {</span>
<span class="pl-s1">        <span class="pl-smi">$dal</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">ElasticsearchDAL</span>(<span class="pl-smi">$this</span>, app(<span class="pl-c1">Client</span><span class="pl-k">::</span><span class="pl-c1">class</span>), <span class="pl-k">new</span> <span class="pl-c1">DALEmitter</span>());</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-k">parent</span><span class="pl-k">::</span>__construct(<span class="pl-smi">$dal</span>, <span class="pl-smi">$attributes</span>);</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">    <span class="pl-c">// ...</span></span>
<span class="pl-s1">}</span></pre></div>

<p>There are the following events:</p>

<ul>
<li>
<code>DALMediator::EVENT_BEFORE_SEARCH</code> is triggered before any search.</li>
<li>
<code>DALMediator::EVENT_AFTER_SEARCH</code> is triggered after any search.</li>
</ul>

<p><strong>TO BE CONTINUED...</strong></p>

<p><a href="https://github.com/TODO" class="user-mention">@TODO</a>:</p>

<ul>
<li>Add documentation about filters</li>
</ul>

<h2>
<a id="change-log" class="anchor" href="#change-log" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Change log</h2>

<p>Please see <a href="CHANGELOG.md">CHANGELOG</a> for more information what has changed recently.</p>

<h2>
<a id="testing" class="anchor" href="#testing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Testing</h2>

<div class="highlight highlight-source-shell"><pre>$ composer <span class="pl-c1">test</span></pre></div>

<h2>
<a id="contributing" class="anchor" href="#contributing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Contributing</h2>

<p>Please see <a href="CONTRIBUTING.md">CONTRIBUTING</a> and <a href="CONDUCT.md">CONDUCT</a> for details.</p>

<h2>
<a id="security" class="anchor" href="#security" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Security</h2>

<p>If you discover any security related issues, please email <a href="mailto:isswp101@gmail.com">isswp101@gmail.com</a> instead of using the issue tracker.</p>

<h2>
<a id="credits" class="anchor" href="#credits" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Credits</h2>

<ul>
<li><a href="https://github.com/isswp101">Sergey Sorokin</a></li>
<li><a href="../../contributors">All Contributors</a></li>
</ul>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>License</h2>

<p>The MIT License (MIT). Please see <a href="LICENSE.md">License File</a> for more information.</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/isswp101/elasticsearch-eloquent">Elasticsearch Eloquent</a> is maintained by <a href="https://github.com/isswp101">isswp101</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
